---
title: "rsa_fir_glass_12_30_18"
author: "WBR"
date: "10/24/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_chunk$set(out.width = "70%")
```

## Load and prepare data 

```{r}
# RSA sum stats
library(tidyverse)
library(afex)
library(ggforce)
library('emmeans')
library(parallel) 

# SVSS with positions and beta threshold
rsa = read.table("/Users/wbr/walter/fmri/sms_scan_analyses/rsa_singletrial/rsa_fir/RSAmeans_fir_glass_2_28_19_5ptile_atanh.txt", header = TRUE, stringsAsFactors = TRUE)

# noisiest subject
bad_subs = c('s001', "s008","s016", "s027","s043", "s032","s039") # , "s041"    
rsa$drop_subs = rsa$sub %in% bad_subs
rsa = rsa[!(rsa$drop_subs == TRUE),]


# extreme pearson vals
# rsa$too_low = rsa$similarity < -.5
# rsa = rsa[!(rsa$too_low == TRUE),]
# ## a couple that are 1 somehow..
# rsa$too_high = rsa$similarity > .8
# rsa = rsa[!(rsa$too_high == TRUE),]

# extreme z vals
rsa$too_low = rsa$similarity < -1
rsa = rsa[!(rsa$too_low == TRUE),]
## a couple that are 1 somehow..
rsa$too_high = rsa$similarity > 1
rsa = rsa[!(rsa$too_high == TRUE),]


# drop na's
rsa = rsa %>% drop_na(similarity)
       
# rsa.sumstats = rsa %>% group_by(roi, condition) %>% summarise(mean = mean(similarity), sd = sd(similarity)) %>% ungroup()

# fix roi labels
rsa$roi = gsub("-", "_", rsa$roi)
rsa$roi = gsub("reslice_", "", rsa$roi)

# PMAT 3.0 labels
# modulelabs = read.table("2_18_glasser_pmat_labels_forR.csv",header = TRUE, stringsAsFactors = TRUE, sep =",")
# adds node strength
modulelabs = read.table("2_20_glasser_pmat_nodestrength.csv",header = TRUE, stringsAsFactors = TRUE, sep =",")
# convert nodestrength to percentile
modulelabspct = modulelabs %>%  group_by(Module) %>% mutate(p_node = percent_rank(node_strength)) %>% ungroup()
topmodulelabs = modulelabspct %>% filter(p_node >= .15)

LANGrois = topmodulelabs %>%  filter(Module == 1)
PMrois = topmodulelabs %>%  filter(Module == 2)
ATrois = topmodulelabs %>%  filter(Module == 3)

# LANGrois = modulelabs %>%  filter(Module == 1)
# PMrois = modulelabs %>%  filter(Module == 2)
# ATrois = modulelabs %>%  filter(Module == 3)

# problem ROI, needs investigating
PMrois = PMrois %>%  filter(ROI != "L_s6-8_ROI")


# make networks factor
rsa$lang = rsa$roi %in% LANGrois$ROI
rsa$AT = rsa$roi %in% ATrois$ROI
rsa$PM = rsa$roi %in% PMrois$ROI

rsa$vischeck = grepl(".*V\\d.*",rsa$roi)

# now assign group label in single column
rsa$roi_group = ifelse(rsa$PM == TRUE, "PM", ifelse(rsa$AT == TRUE, "AT", ifelse(rsa$lang == TRUE, "LANG", ifelse(rsa$vischeck == TRUE, "VIS", "other"))))

# delete the logical vectors
rsa[,6:12] = NULL
# make group a factor
rsa$roi_group = as.factor(rsa$roi_group)

###### adding sub networks 
mpfc_subgroup = modulelabs %>% filter(sub_group == "mpfc")
pm_subgroup = modulelabs %>% filter(sub_group == "posterior_medial")
lp_subgroup = modulelabs %>% filter(sub_group == "lateral_parietal")
t_subgroup = modulelabs %>% filter(sub_group == "temporal")
d_subgroup = modulelabs %>% filter(sub_group == "dpfc")
mtl_subgroup = modulelabs %>% filter(sub_group == "mtl")

rsa$pm_subgroup = rsa$roi %in% pm_subgroup$ROI
rsa$mpfc_subgroup = rsa$roi %in% mpfc_subgroup$ROI
rsa$lp_subgroup = rsa$roi %in% lp_subgroup$ROI
rsa$t_subgroup = rsa$roi %in% t_subgroup$ROI
rsa$d_subgroup = rsa$roi %in% d_subgroup$ROI
rsa$mtl_subgroup = rsa$roi %in% mtl_subgroup$ROI

rsa$sub_group = ifelse(rsa$mpfc_subgroup == TRUE, "mpfc", ifelse(rsa$pm_subgroup == TRUE,"pm_sub",ifelse(rsa$lp_subgroup == TRUE, "lp",ifelse(rsa$t_subgroup == TRUE, "temporal",ifelse(rsa$d_subgroup == TRUE, "dorsal",ifelse(rsa$mtl_subgroup == TRUE, "mtl","tbd"))))))
rsa$sub_group = as.factor(rsa$sub_group)

rsa[,7:12] = NULL

rsa$othergroup = ifelse(rsa$sub_group == "lp" | rsa$sub_group == "pm_sub", "PM_super",ifelse(rsa$sub_group == "dorsal" | rsa$sub_group == "mpfc","pfc","other"))
# | rsa$sub_group == "temporal"

rsa$dropthis = rsa$sub == "s002" & rsa$roi == "R_SFL_ROI"
rsa = rsa[!(rsa$dropthis == TRUE),]
#################
# rt  diffs
rt.diffs =  read.csv("rtdiffs_11_1_18.csv")
rt.diffs[,1] =NULL 

```

## temporary putting freesurfer ROI data in chunk below copied from FIR_10_31_18_truecoreg
```{r}
# RSA sum stats
library(tidyverse)
library(afex)
library(ggforce)
library('emmeans')



# SVSS with positions and beta threshold
rsa = read.table("/Users/wbr/walter/fmri/sms_scan_analyses/rsa_singletrial/rsa_fir/RSAmeans_fir_FS_2_25_19_5ptile.txt", header = TRUE, stringsAsFactors = TRUE)

# noisiest subject
bad_subs = c('s001', "s008","s016", "s027","s043","s032","s039") # , "s041"
rsa$drop_subs = rsa$sub %in% bad_subs
rsa = rsa[!(rsa$drop_subs == TRUE),]

# s022 rh-prc is messed up, 20 most negatvie correlations in whole dataset. NA all of those for time being
rsa$too_low = rsa$similarity < -.4
rsa = rsa[!(rsa$too_low == TRUE),]
## a couple that are 1 somehow..
rsa$too_high = rsa$similarity > .8
rsa = rsa[!(rsa$too_high == TRUE),]
       
rsa.sumstats = rsa %>% group_by(roi, condition) %>% summarise(mean = mean(similarity), sd = sd(similarity)) %>% ungroup()


# the rois
PM_rois = c('near-phc-ant-L', 'near-phc-ant-R', 'lh-ANG', 'rh-ANG', 'lh-PCC', 'rh-PCC',	'lh-Prec',	'rh-Prec', 'lh-RSC', 'rh-RSC')
AT_rois = c('near-prc-L',	'near-prc-R', 	'lh-TPole', 	'rh-TPole', 'lh-OFC', 'rh-OFC')
HIPP_rois = c('near-hipp-body-L',	'near-hipp-body-R',	'near-hipp-head-L',	'near-hipp-head-R', 'near-hipp-tail-L', 'near-hipp-tail-R')
PM_HIPP_rois = c('near-hipp-body-L',	'near-hipp-body-R',	'near-hipp-head-L',	'near-hipp-head-R', 
                 'near-phc-ant-L', 'near-phc-ant-R', 'lh-ANG', 'rh-ANG', 'lh-PCC', 'rh-PCC',	'lh-Prec',	'rh-Prec', 'lh-RSC', 'rh-RSC')
IFG= c( 'lh-inf-opercular', 'lh-inf-triang', 'rh-inf-opercular', 'rh-inf-triang', 'rh-inf-orbital', 'lh-inf-orbital')
frontal = c( 'lh-inf-opercular', 'lh-inf-triang', 'rh-inf-opercular', 'rh-inf-triang', 'rh-inf-orbital', 'lh-inf-orbital','rh-insula-inf','lh-insula-inf','rh-insula-short','lh-insula-short','lh-VMPFC','rh-VMPFC','lh-MPFC','rh-MPFC','rh-MTG','lh-MTG','rh-OFC','lh-OFC')
# 'lh-insula-short', 'lh-insula-inf','rh-insula-short', 'rh-insula-inf', 
# vmpfc = c('near-VMPFC') 

# make networks factor
# first make logical vectors for member regions
rsa$PM = rsa$roi %in% PM_rois
rsa$AT = rsa$roi %in% AT_rois
rsa$HIPP = rsa$roi %in% HIPP_rois
rsa$PM_HIPP = rsa$roi %in% PM_HIPP_rois
rsa$IFG = rsa$roi %in% IFG
rsa$frontal = rsa$roi %in% frontal

# now assign group label in single column
# rsa$roi_group = ifelse(rsa$PM == TRUE, "PM", ifelse(rsa$AT == TRUE, "AT", ifelse(rsa$HIPP == TRUE,"HIPP", "Other" )))
rsa$roi_group = ifelse(rsa$PM == TRUE, "PM", ifelse(rsa$AT == TRUE, "AT", ifelse(rsa$HIPP == TRUE,"HIPP", ifelse(rsa$IFG == TRUE, "IFG","Other"))))
# delete the logical vectors
rsa[,6:11] = NULL
# make group a factor
rsa$roi_group = as.factor(rsa$roi_group)

# wish I did this earlier but hindsight yada yada
rsa$roi = gsub(".*body-L$", "lh-hipp-body", rsa$roi)
rsa$roi = gsub(".*body-R$", "rh-hipp-body", rsa$roi)
rsa$roi = gsub(".*head-L$", "lh-hipp-head", rsa$roi)
rsa$roi = gsub(".*head-R$", "rh-hipp-head", rsa$roi)
rsa$roi = gsub(".*tail-L$", "lh-hipp-tail", rsa$roi)
rsa$roi = gsub(".*tail-R$", "rh-hipp-tail", rsa$roi)
rsa$roi = gsub(".*ant-L$", "lh-phc-ant", rsa$roi)
rsa$roi = gsub(".*ant-R$", "rh-phc-ant", rsa$roi)
# rsa$roi = gsub(".*VMPFC", "VMPFC", rsa$roi)
rsa$roi = gsub(".*prc-L$", "lh-prc", rsa$roi)
rsa$roi = gsub(".*prc-R$", "rh-prc", rsa$roi)
########################
# PMAT AT and HIPP only
rsa.PMAT = rsa %>% filter(roi_group != "Other") %>% filter(roi_group != "IFG")  %>% filter(roi_group != "frontal")
rsa.frontal = rsa %>% filter(rsa$frontal == TRUE)

# rt  diffs
rt.diffs =  read.csv("rtdiffs_11_1_18.csv")
rt.diffs[,1] =NULL 

# nice labels
PM_labs = c('lh-phc-ant', 'rh-phc-ant', 'lh-ANG', 'rh-ANG', 'lh-PCC', 'rh-PCC',	'lh-Prec',	'rh-Prec', 'lh-RSC', 'rh-RSC')
AT_labs = c('lh-prc',	'rh-prc', 	'lh-TPole', 	'rh-TPole', 'lh-OFC', 'rh-OFC')
HIPP_labs = c('lh-hipp-body','rh-hipp-body','lh-hipp-head','rh-hipp-head','lh-hipp-tail','rh-hipp-tail')

```



## Plot by network cluster

```{r fig.width = 12, fig.asp = .62}
clust.fig.dat = rsa  %>% filter(position %in% 11:20) %>% group_by(sub,condition,roi_group) %>% summarise(similarity = mean(similarity))
clusters.rois = ggplot(data = clust.fig.dat, aes(x = factor(condition), y = similarity))  + geom_boxplot(outlier.shape = NA)  +  facet_wrap( ~roi_group) + scale_y_continuous(limits = c(-.05, .2))
clusters.rois = clusters.rois + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -90,hjust = 0)) + scale_x_discrete(labels = c("Intact","Same Position","Scrambled"))
clusters.rois
```

```{r}
rsa.PM = rsa %>% filter(roi_group == "PM")
line.dat = rsa.PMAT  %>% filter(roi == "rh-Prec")%>%  group_by(condition,position) %>% summarise(similarity = mean(similarity))


PM.line = ggplot(data = line.dat, aes(x = position,group = condition, y = similarity))   + geom_smooth(aes(linetype=condition),method="loess") # + facet_wrap(~roi)# + scale_y_continuous(limits = c(-.05, .3))
# PM.check = PM.check + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact","Same Position","Scrambled")) 
PM.line

```

### facet line plots

```{r}

rsa.PM = rsa %>% filter(rsa$roi == "lh-occ-pole" | rsa$roi == "rh-occ-pole")
line.dat = rsa.PM  %>% group_by(condition,position,roi) %>% summarise(similarity = mean(similarity))


PM.line = ggplot(data = line.dat, aes(x = position,group = condition, y = similarity)) + geom_line(aes(linetype=condition)) + facet_wrap(~roi) 
  # + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))
  
PM.line

```

### paginate line plots
```{r}



for (ipage in 1:3) {
rsa.PM = rsa %>% filter(rsa$frontal == TRUE)
line.dat = rsa.PM  %>% group_by(condition,position,roi) %>% summarise(similarity = mean(similarity))


PM.line = ggplot(data = line.dat, aes(x = position,group = condition, y = similarity)) + geom_line(aes(linetype=condition)) + facet_wrap_paginate(~roi,nrow=3,ncol=2,page = ipage) 
  # + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))
  fname = sprintf("PFCish_fir_5ptile_11_1_18_%d.pdf", ipage) 
  ggsave(fname)
}
```

### poster quality line plots
```{r}


# post_rois = unique(LANGrois$ROI)
post_rois = c("L_PSL_ROI","L_55b_ROI")


for (iroi in 1:length(post_rois)) {
# rsa.PM = rsa %>% filter(rsa$frontal == TRUE)
line.dat = rsa %>%  filter(roi == post_rois[iroi]) %>% filter(condition != "random") %>%  group_by(condition,position) %>% summarise(similarity = mean(similarity)) 


PM.line = ggplot(data = line.dat, aes(x = position,group = condition, y = similarity, colour = condition)) + geom_line(size = 2) +geom_point(size = 2) # aes(linetype=condition) 
PM.line = PM.line + scale_color_brewer(palette = "Dark2") + theme(text = element_text(size = 30, face = "bold")) + theme(strip.background = element_blank(),strip.text= element_blank()) + theme(legend.position="none") + xlab("timepoint")
PM.line

# + scale_color_manual(values = c("1B9E77","D95F02","7570B3"))
#+  facet_wrap_paginate(~roi,nrow=3,ncol=2,page = ipage) 
  # + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))

  fname = sprintf("march19_timecourse_rsa/LANG_%s_timcourse_win0.pdf", post_rois[iroi])
  ggsave(fname, plot = PM.line, dpi = 600,width = 8, height = 5,units = "in")
}
```

#### subject level line plots

```{r}

indie.sub.plots = function(cur_sub,region){
rsa.PM = rsa %>% filter(rsa$roi == region)
line.dat = rsa.PM %>% filter(sub == cur_sub) %>% group_by(condition,position) %>% summarise(similarity = mean(similarity))


PM.line = ggplot(data = line.dat, aes(x = position,group = condition, y = similarity)) + geom_line(aes(linetype=condition)) # + facet_wrap(~sub) 
  # + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))
  
PM.line
}
```

```{r}
lapply(unique(rsa$sub),indie.sub.plots, region = "rh-Prec")

```


```{r}
# %>%  filter(position == 1 |  position == 2 |position == 3 | position == 4 | position == 5)
clust.fig.dat = rsa %>% filter(condition != "random")  %>% filter(position %in% 1:25)  %>% group_by(sub,condition,roi_group,position) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
clust.fig.dat = droplevels(clust.fig.dat)
# clust.fig.dat$roi = as.factor(clust.fig.dat$roi)
a1 = aov_ez("sub", "similarity", clust.fig.dat, within = c("condition","roi_group", "position"))
a1
em1 = emmeans(a1, ~ condition|roi_group)
pairs(em1, adjust = NULL)
# contrast(ls.m1, alpha=0.05, method="pairwise", adjust= "holm")


```

###########################
# network level sliding window ttests!

### changed roi_group!!!!!
```{r}
wbr.sliding.ttest.network = function(midval,region,winval,con1,con2) {
# grab grouped/meaned data for each condition 
temp.df = rsa %>% filter(sub_group == region) %>% filter(condition == con1) %>%   filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat1 = temp.df$similarity

temp.df = rsa %>% filter(sub_group == region) %>% filter(condition == con2) %>%   filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat2 = temp.df$similarity

# run ttest
if (length(dat1) == length(dat2)  && length(dat1) > 0){
  print(region)
  result = t.test(dat1, dat2, paired = TRUE)
  pval = result$p.value
  tval = result$statistic
  out = c(pval,tval)
  return(out)
} else {
  fprint('problem with %s !!!',region )
}
}
```

```{r}
# use this to get the true tstats for every timepoint. 
tstatdat = lapply(1:32,wbr.sliding.ttest.network,winval=0,region="temporal",con1="intact",con2="scrambled")
tstatdat = data.frame(matrix(unlist(tstatdat), nrow=32, byrow=T))
tstatdat$timepoint = 1:32
tstatdat = plyr::rename(tstatdat, c("X1"="pval","X2"="tval"))

#plot that shit
tstat.plot = ggplot(data = tstatdat,(aes(x =timepoint , y= tval,group =1)))  + geom_point(size = 3) +geom_line(size =2) + theme(text = element_text(size = 30, face = "bold"))  + ylab("t stat")  +
geom_hline(aes(yintercept = 0)) + scale_y_continuous(limits= c(-2.25 , 3.5),breaks = c(-2,-1,0,1,2,3))
  # geom_segment(x = 18,y =-.25,xend= 18,yend = .25, color = "red",size=.75) 

tstat.plot
# ggsave("pm_subnet_tstatlineplots/sliding.tstat_pmmtl.pdf", plot = tstat.plot, dpi = 600,width = 8, height = 5,units = "in")
```

# put a bunch of line plots on the same figure
# this uses make_tval_df and wbr.sliding.ttest which are below
```{r}
tempdf = rsa %>% filter(roi_group == "LANG")
cur_rois = unique(tempdf$roi)
# cur_rois = droplevels(cur_rois)
list_of_dfs = NULL
list_of_dfs = lapply(cur_rois,make_tval_df)
multiplot_dat = do.call(rbind,list_of_dfs)

#plot that shit
tstat.plot = ggplot(data = multiplot_dat,(aes(x =timepoint , y= tval,group =ROI)))  + geom_point(size = 1) +geom_line(size =1) + theme(text = element_text(size = 30, face = "bold"))  + ylab("t stat")  + theme(legend.position="none") +
geom_hline(aes(yintercept = 0)) + scale_y_continuous(limits= c(-2.25 , 3.5),breaks = c(-2,-1,0,1,2,3))
  # geom_segment(x = 18,y =-.25,xend= 18,yend = .25, color = "red",size=.75) 

tstat.plot
# ggsave("pm_subnet_tstatlineplots/mpfc_allrois_tstatline.pdf", plot = tstat.plot, dpi = 600,width = 8, height = 5,units = "in")

```

```{r}


```
#########################
correct for timepoint MC with permutation tests

# start with func for computing true sliding window condition mean difference time courses
```{r}
make.sliding.df = function(midval,network,winval,con1,con2) {
# grab grouped/meaned data for each condition 
temp.df = rsa %>% filter(sub_group == network) %>% filter(condition == con1) %>%   filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat1 = temp.df$similarity

temp.df = rsa %>% filter(sub_group == network) %>% filter(condition == con2) %>%   filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
dat2 = temp.df$similarity

temp.df$diff = dat1-dat2
temp.df$similarity =NULL
temp.df$timepoint = rep(midval,27)
return(temp.df)
# compute difference between means
# temp.df = temp.df %>% mutate(cond.diff = )
}
```

```{r}
# execute the above function for every timepoint, returning a list of df's, one for each timepoint, that contain mean differences for every subject

# Calculate the number of cores
no_cores = detectCores() - 1
# Initiate cluster
cl = makeCluster(no_cores,type = "FORK")

list_of_dfs = NULL
list_of_dfs = parLapply(cl,1:32,make.sliding.df,winval=0,network="temporal",con1="intact",con2="scrambled")
timecourse_dat= do.call(rbind,list_of_dfs)

stopCluster(cl)
```

```{r}
ttestfunky = function(cur_tp,data){
  temp_timecourse_dat =data
  temp.df = temp_timecourse_dat %>% filter(timepoint == cur_tp)
temp.df = droplevels(temp.df)
dat1 = temp.df$permdiff

if (length(dat1) == 27){
  result = t.test(dat1)
  # pval = result$p.value
  tval = result$statistic
  out = c(tval)
  return(out)
} else {
  warning("\nSomething funked up!\n")
}
}
```

```{r}

# generate random condition flip for each subject and apply identically for every timepoint within a sub
perm.data = function(permnum){
  print(sprintf('Perm #%d',permnum))
  labshuffle = rep(sample(c(-1,1),27,replace=TRUE),32)
  temp_timecourse_dat = timecourse_dat
  temp_timecourse_dat = temp_timecourse_dat %>% mutate(permdiff = diff*labshuffle)
  return(temp_timecourse_dat)
}

# calls ttest funky to run ttests for each timepoint
evaltval = function(data){
  temp_timecourse_dat = data
  tvals = unlist(lapply(5:10,ttestfunky,temp_timecourse_dat))
  maxt = max(tvals)
  # mint = min(tvals)
  # if (abs(maxt) > abs(mint)){
  #   outval = maxt
  # } else {
  #   outval = mint
  # }
  outval = maxt
  return(outval)
  
  # cluster size instead of max tval
  # pvals = unlist(lapply(1:25,ttestfunky,temp_timecourse_dat))
  # smallps = pvals < .05
  # # magic to find max consecutive TRUEs
  # clustsize = max(rle(smallps)$lengths[rle(smallps)$values])
  # if (clustsize < 1){
  #   clustsize = 0
  # }
  # return(clustsize)
}

run.the.perms = function(permnum){
  temp_timecourse_dat = perm.data(permnum)
  outval = evaltval(temp_timecourse_dat)
  return(outval)
}
```



### finally run the perms
```{r}
# Calculate the number of cores
no_cores = detectCores() - 1
# Initiate cluster
cl = makeCluster(no_cores,type = "FORK")

permhist = unlist(parLapply(cl,1:10000,run.the.perms))

stopCluster(cl)
```

```{r}
perm.df = data.frame(permhist)
perm.df = perm.df %>% mutate(ptile = percent_rank(permhist))
```



```{r}
# plot every subject's condition difference timecourse to spot check
time.diff.plot = ggplot(data = temp_timecourse_dat,(aes(x =timepoint , y= permdiff,group =sub)))  + geom_point(size = 1) +geom_line(size =1) + theme(text = element_text(size = 30, face = "bold"))  + ylab("t stat")  +
geom_hline(aes(yintercept = 0)) + scale_y_continuous(limits= c(-.15 , .15),breaks = c())
  # geom_segment(x = 18,y =-.25,xend= 18,yend = .25, color = "red",size=.75) 

time.diff.plot
```


#########
# sliding window ttests for individual regions!
################################
```{r}
wbr.sliding.ttest = function(midval,region,winval,con1,con2) {
  temp.df = rsa %>% filter(roi == region) %>% filter(condition == con1) %>%   filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat1 = temp.df$similarity

temp.df = rsa %>% filter(roi == region) %>% filter(condition == con2) %>%   filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat2 = temp.df$similarity
if (length(dat1) == length(dat2) && length(dat1) > 0){
  print(region)
  result = t.test(dat1, dat2, paired = TRUE)
  pval = result$p.value
  tval = result$statistic
# pval = sprintf('%.3f',as.numeric(fromcor[3]))
# rval = sprintf('%.3f',as.numeric(fromcor[4]))

  out = c(pval,tval)
  return(out)
  
} else {
  pval = NA
  tval = NA
  out = c(pval,tval)
  return(out)
  # print(sprintf('problem with %s !!!',region))
}
}
```

```{r}
tstatdat = lapply(1:32,wbr.sliding.ttest,winval=0,region="L_V1_ROI",con1="intact",con2="scrambled")
tstatdat = data.frame(matrix(unlist(tstatdat), nrow=32, byrow=T))
tstatdat$timepoint = 1:32
tstatdat = plyr::rename(tstatdat, c("X1"="pval","X2"="tval"))

#plot that shit
tstat.plot = ggplot(data = tstatdat,(aes(x =timepoint , y= tval,group =1)))  + geom_point(size = 3) +geom_line(size =2) + theme(text = element_text(size = 30, face = "bold"))  + ylab("t stat")  +
geom_hline(aes(yintercept = 0)) + scale_y_continuous(limits= c(-2.25 , 3.5),breaks = c(-2,-1,0,1,2,3))
# +
  # geom_segment(x = 18,y =-.25,xend= 18,yend = .25, color = "red",size=.75) 

tstat.plot
# ggsave("sfn18_figs/sliding.tstat_lh-MTG.pdf", plot = tstat.plot, dpi = 600,width = 8, height = 5,units = "in")
```

#############
# use sliding ttest single region function to make a region tstat plots for all 3net regions
```{r}
tstat_line_region = function(inputroi){
  
tstatdat = lapply(1:32,wbr.sliding.ttest,winval=0,region=inputroi,con1="intact",con2="scrambled")
tstatdat = data.frame(matrix(unlist(tstatdat), nrow=32, byrow=T))
tstatdat$timepoint = 1:32
tstatdat = plyr::rename(tstatdat, c("X1"="pval","X2"="tval"))

#plot that shit
tstat.plot = ggplot(data = tstatdat,(aes(x =timepoint , y= tval,group =1)))  + geom_point(size = 3) +geom_line(size =2) + theme(text = element_text(size = 30, face = "bold"))  + ylab("t stat")  +
geom_hline(aes(yintercept = 0)) + scale_y_continuous(limits= c(-3 , 4),breaks = c(-2,-1,0,1,2,3,4))
# +
  # geom_segment(x = 18,y =-.25,xend= 18,yend = .25, color = "red",size=.75) 

# tstat.plot
fname = sprintf("LANG_tstat_plots_win0/%s_tstat_win0_z.pdf", inputroi)
ggsave(fname, plot = tstat.plot, dpi = 600,width = 8, height = 5,units = "in")
}
```

```{r echo = FALSE results='hide'}
temp_df = rsa %>% filter(roi_group == "LANG")
cur_rois = unique(temp_df$roi)
# cur_rois = droplevels(cur_rois)
lapply(cur_rois,tstat_line_region)
```



#######################################
# use sliding ttest single region function to make df of tvals for all PMAT regions, then save df 

```{r}
make_tval_df = function(inputroi){
  # get the tvals
  tstatdat = lapply(1:32,wbr.sliding.ttest,winval=0,region=inputroi,con1="intact",con2="scrambled")
  tstatdat = data.frame(matrix(unlist(tstatdat), nrow=32, byrow=T), stringsAsFactors = FALSE)
  tstatdat$timepoint = 1:32
  tstatdat = plyr::rename(tstatdat, c("X1"="pval","X2"="tval"))
  tstatdat$ROI = inputroi
  return(tstatdat)
}

```

# brain movie by network
```{r}
# put all the pieces together
cur_rois = unique(PMrois$ROI)
cur_rois = droplevels(cur_rois)
list_of_dfs = NULL
list_of_dfs = lapply(cur_rois,make_tval_df)
brain_movie_datPM = do.call(rbind,list_of_dfs)
brain_movie_datPM$network = "PM"

cur_rois = unique(ATrois$ROI)
cur_rois = droplevels(cur_rois)
list_of_dfs = NULL
list_of_dfs = lapply(cur_rois,make_tval_df)
brain_movie_datAT = do.call(rbind,list_of_dfs)
brain_movie_datAT$network = "AT"

cur_rois = unique(LANGrois$ROI)
cur_rois = droplevels(cur_rois)
list_of_dfs = NULL
list_of_dfs = lapply(cur_rois,make_tval_df)
brain_movie_datLANG = do.call(rbind,list_of_dfs)
brain_movie_datLANG$network = "LANG"

# brain_movie_dat = bind_rows(brain_movie_datPM,brain_movie_datAT,brain_movie_datLANG)
```

```{r}
#  R_7Am, L_5L, L_DVT had problem timepoints in RSA but not univariate with ttests
rsa = rsa[!(rsa$roi == "R_7Am_ROI"),]
rsa = rsa[!(rsa$roi == "L_5L_ROI"),]
rsa = rsa[!(rsa$roi == "L_DVT_ROI"),]
rsa = rsa[!(rsa$roi == "L_H_ROI"),]
rsa = rsa[!(rsa$roi == "R_H_ROI"),]
rsa = rsa[!(rsa$roi == "R_7Pm_ROI"),]
rsa = rsa[!(rsa$roi == "R_5mv_ROI"),]
rsa = rsa[!(rsa$roi == "R_6ma_ROI"),]
rsa = rsa[!(rsa$roi == "R_POS2_ROI"),]

cur_rois = unique(rsa$roi)
# cur_rois = droplevels(cur_rois)

list_of_dfs = NULL
brain_movie_dat = NULL
list_of_dfs = lapply(cur_rois,make_tval_df)
brain_movie_dat = do.call(rbind,list_of_dfs)
```


```{r}
# make sure that data brought into matlab from excel are sorted such that all timepoints in the first roi are added then the next roi all timepoints
# also, fsleyes and many other programs will restrict the negative range to the max value. i.e., if the max is 3, and your data has a value of -4, it shows up as -3..... -_-.......
write_csv(brain_movie_dat, "brainmoviedata_rsa_allglass_win0_3_5_19.csv")

rois = unique(brain_movie_dat$ROI)
write_csv(data.frame(rois),"rsa_unique_rois.csv")
```












OLD STUFF

```{r}

# 21/27 subs have higher PS for intact compared to scrambled in lh-Prec
# 21/27 subs have higher PS for intact compared to scrambled in rh-Prec, but not the exact same as above

temp.df = rsa %>% filter(roi == "lh-Prec") %>% filter(condition == "intact") %>%    filter(position %in% 11:16) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat1 = temp.df$similarity

temp.df = rsa %>% filter(roi == "lh-Prec") %>% filter(condition == "scrambled") %>%   filter(position %in% 11:16) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat2 = temp.df$similarity

dat1 - dat2
mean(dat1 - dat2)

# 12/27 have higher similarity in rh-Prec in times 11:16
# only 7 in lh-prec

```



```{r}
wbr.allps.ttest = function(region,df,con1,con2) {
  temp.df = df %>% filter(roi == region)  %>% filter(condition == con1) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat1 = temp.df$similarity

temp.df = df %>% filter(roi == region) %>% filter(condition == con2) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat2 = temp.df$similarity
if (length(dat1) == length(dat2)){
  print(region)
  out = t.test(dat1, dat2, paired = TRUE)
  return(out)
} else {
  fprint('problem with %s !!!',region )
}
}
```

```{r}


lapply(post_rois, wbr.allps.ttest, df=rsa,con1='intact',con2='scrambled')



```



## correlations
```{r}
rsa.diff.ps = rsa %>% filter(sub != "s023") 

rsa.diff.ps = rsa.diff.ps %>% filter(position == 1 |  position == 2 |position == 3 | position == 4 | position == 5) %>%  group_by(sub,condition,roi) %>% filter(roi == "lh-hipp-body", condition != "random") %>% summarise(simmean = mean(similarity))
rsa.diff.ps = rsa.diff.ps %>%  spread(condition, simmean) 
rsa.diff.ps = rsa.diff.ps %>% mutate(psdiffs = intact - scrambled)
rsa.diff.ps = data.frame(rsa.diff.ps)

rsa.diff.ps$rtdiffs = rt.diffs$rtdiff

# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s034")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s009")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s018")

cor.test(rsa.diff.ps$rtdiffs,rsa.diff.ps$psdiffs)

# positive rt means faster on intact than scrambled 
# positive ps means higher ps for intact 

corr.plot = ggplot(data = rsa.diff.ps,(aes(x = psdiffs, y= rtdiffs)))  + geom_point(size = 5) +   geom_smooth(method='lm')
corr.plot = corr.plot + ggtitle("r = 0.46, p = 0.02")  + theme(legend.position="none") + labs(x = "Pattern Similarity Difference", y = "Reaction Time Difference (ms)")
corr.plot = corr.plot + theme(text = element_text(size = 30, face = "bold"))
corr.plot.phc = corr.plot
corr.plot.phc 
# ggsave("lh_hipp_body_diff_corr.pdf", plot = last_plot(), dpi = 600 )


```





```{r}

rsa.diff.ps = rsa %>% filter(sub != "s023")
rsa.diff.ps = rsa.diff.ps %>% filter(position %in% 1:25) %>%  group_by(sub,condition,roi) %>% filter(roi == "rh-Prec", condition != "random") %>% summarise(simmean = mean(similarity))
rsa.diff.ps = rsa.diff.ps %>%  spread(condition, simmean) 
rsa.diff.ps = rsa.diff.ps %>% mutate(psdiffs = intact - scrambled)
rsa.diff.ps = data.frame(rsa.diff.ps)

rsa.diff.ps$rtdiffs = rt.diffs$rtdiff
write.csv(rsa.diff.ps,"rh-precdiffplot.csv")



```


```{r}

lapply(unique(rsa$roi),wbr.first5.corrplot)

```


##### corr plot last 5

```{r}

wbr.last5.corrplot = function(region) {
rsa.diff.ps = rsa %>% filter(sub != "s023") 
# 

rsa.diff.ps = rsa.diff.ps %>% filter(position == 21 |  position == 22 |position == 23 | position == 24 | position == 25) %>% group_by(sub,condition,roi) %>% filter(roi == region, condition != "random") %>% summarise(simmean = mean(similarity))
rsa.diff.ps = rsa.diff.ps %>%  spread(condition, simmean) 
rsa.diff.ps = rsa.diff.ps %>% mutate(psdiffs = intact - scrambled)
rsa.diff.ps = data.frame(rsa.diff.ps)

rsa.diff.ps$rtdiffs = rt.diffs$rtdiff

# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s034")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s009")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s018")

fromcor = cor.test(rsa.diff.ps$rtdiffs,rsa.diff.ps$psdiffs)

if (fromcor[3] > .05){
return()
}

pval = sprintf('\np = %.3f;\n',as.numeric(fromcor[3]))
rval = sprintf('r = %.3f',as.numeric(fromcor[4]))
# positive rt means faster on intact than scrambled 
# positive ps means higher ps for intact 

corr.plot = ggplot(data = rsa.diff.ps,(aes(x = psdiffs, y= rtdiffs)))  + geom_point(size = 5) +   geom_smooth(method='lm')
corr.plot = corr.plot + ggtitle(paste(region,pval,rval))  + theme(legend.position="none") + labs(x = "Pattern Similarity Difference", y = "Reaction Time Difference (ms)")
corr.plot = corr.plot + theme(text = element_text(size = 20, face = "bold"))
corr.plot.phc = corr.plot
corr.plot.phc 
# ggsave("lh_hipp_body_diff_corr.pdf", plot = last_plot(), dpi = 600 )
}

```


```{r}

lapply(unique(rsa$roi),wbr.last5.corrplot)

```

##### corr middle 15

```{r}

## changed from by region to othergroup!!
wbr.anyps.corrplot = function(region,pstart,pend) {
rsa.diff.ps = rsa %>% filter(sub != "s023") 
# 

rsa.diff.ps = rsa.diff.ps %>% filter(position %in% pstart:pend) %>% group_by(sub,condition,sub_group) %>% filter(sub_group == region, condition != "random") %>% summarise(simmean = mean(similarity))
rsa.diff.ps = rsa.diff.ps %>%  spread(condition, simmean) 
rsa.diff.ps = rsa.diff.ps %>% mutate(psdiffs = intact - scrambled)
rsa.diff.ps = data.frame(rsa.diff.ps)

rsa.diff.ps$rtdiffs = rt.diffs$rtdiff

# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s034")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s009")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s018")

fromcor = cor.test(rsa.diff.ps$rtdiffs,rsa.diff.ps$psdiffs)

if (fromcor[3] > .05){
return()
}

# region = "L Precuneus"
pval = sprintf('p = %.3f;',as.numeric(fromcor[3]))
rval = sprintf('r = %.3f;',as.numeric(fromcor[4]))
prange = sprintf('Timepoint %d to %d',pstart,pend)
# positive rt means faster on intact than scrambled 
# positive ps means higher ps for intact 

 
corr.plot = ggplot(data = rsa.diff.ps,(aes(x = psdiffs, y= rtdiffs)))  + geom_point(size = 3) +   geom_smooth(method='lm')
corr.plot = corr.plot  + theme(legend.position="none") + labs(x = "Pattern Similarity Difference", y = "Reaction Time Difference") + xlim(min=-.2, max=.21) + geom_hline(yintercept = 0) + geom_vline(xintercept = 0) + ggtitle(paste(pval,rval,"Timepoint", pstart))
corr.plot = corr.plot + theme(text = element_text(size = 25, face = "bold"))
corr.plot
# ggtitle(paste(region,pval,rval,prange))

ggsave(sprintf('march19_corr_figs/%s_intact-scrambled_corrplot_pstart%dpend%d.pdf',region,pstart,pend), plot = corr.plot, dpi = 600,width = 8, height = 5.5,units = "in")
}

```


```{r}
wbr.anyps.corrplot(region="pm_sub",pstart =21,pend=21)


```

##### corr intact with ps

```{r}

wbr.intactonly.corrplot = function(region,pstart,pend) {
rsa.diff.ps = rsa %>% filter(sub != "s023") 
# 

rsa.diff.ps = rsa.diff.ps %>% filter(position %in% pstart:pend) %>% group_by(sub,condition,roi) %>% filter(roi == region, condition == "intact") %>% summarise(simmean = mean(similarity))
# rsa.diff.ps = rsa.diff.ps %>%  spread(condition, simmean) 
# rsa.diff.ps = rsa.diff.ps %>% mutate(psdiffs = intact - scrambled)
rsa.diff.ps = data.frame(rsa.diff.ps)

rsa.diff.ps$intactrt = rt.intact$rtmean

# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s034")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s009")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s018")

fromcor = cor.test(rsa.diff.ps$intactrt,rsa.diff.ps$simmean)

if (fromcor[3] > .05){
return()
}

pval = sprintf('p = %.3f;',as.numeric(fromcor[3]))
rval = sprintf('r = %.3f;',as.numeric(fromcor[4]))
prange = sprintf('Reg %d to %d',pstart,pend)
# positive rt means faster on intact than scrambled 
# positive ps means higher ps for intact 

corr.plot = ggplot(data = rsa.diff.ps,(aes(x = simmean, y= intactrt)))  + geom_point(size = 5) +   geom_smooth(method='lm')
corr.plot = corr.plot + ggtitle(paste(region,pval,rval,prange))  + theme(legend.position="none") + labs(x = "Intact PS", y = "Intact PS (ms)")
corr.plot = corr.plot + theme(text = element_text(size = 15, face = "bold"))
corr.plot
ggsave(sprintf('%s_intactonly_corrplot_pstart%dpend%d.pdf',region,pstart,pend), plot = last_plot(), dpi = 600 )
}

```

```{r}


# lapply(unique(rsa$roi),wbr.intactonly.corrplot,pstart =1,pend=25)
lapply(unique(rsa$roi),wbr.intactonly.corrplot,pstart =1,pend=5)
lapply(unique(rsa$roi),wbr.intactonly.corrplot,pstart =6,pend=10)
lapply(unique(rsa$roi),wbr.intactonly.corrplot,pstart =11,pend=15)
lapply(unique(rsa$roi),wbr.intactonly.corrplot,pstart =16,pend=20)
lapply(unique(rsa$roi),wbr.intactonly.corrplot,pstart =21,pend=25)

```


##### corr scrambled with ps

```{r}

wbr.scrambledonly.corrplot = function(region,pstart,pend) {
rsa.diff.ps = rsa %>% filter(sub != "s023") 
# 

rsa.diff.ps = rsa.diff.ps %>% filter(position %in% pstart:pend) %>% group_by(sub,condition,roi) %>% filter(roi == region, condition == "scrambled") %>% summarise(simmean = mean(similarity))
# rsa.diff.ps = rsa.diff.ps %>%  spread(condition, simmean) 
# rsa.diff.ps = rsa.diff.ps %>% mutate(psdiffs = intact - scrambled)
rsa.diff.ps = data.frame(rsa.diff.ps)

rsa.diff.ps$scrambledrt = rt.scrambled$rtmean

# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s034")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s009")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s018")

fromcor = cor.test(rsa.diff.ps$scrambledrt,rsa.diff.ps$simmean)

if (fromcor[3] > .05){
return()
}

pval = sprintf('p = %.3f;',as.numeric(fromcor[3]))
rval = sprintf('r = %.3f;',as.numeric(fromcor[4]))
prange = sprintf('Reg %d to %d',pstart,pend)
# positive rt means faster on intact than scrambled 
# positive ps means higher ps for intact 

corr.plot = ggplot(data = rsa.diff.ps,(aes(x = simmean, y= scrambledrt)))  + geom_point(size = 5) +   geom_smooth(method='lm')
corr.plot = corr.plot + ggtitle(paste(region,pval,rval,prange))  + theme(legend.position="none") + labs(x = "Scrambled PS", y = "Scrambled PS (ms)")
corr.plot = corr.plot + theme(text = element_text(size = 15, face = "bold"))
corr.plot
ggsave(sprintf('%s_scrambledonly_corrplot_pstart%dpend%d.pdf',region,pstart,pend), plot = last_plot(), dpi = 600 )
}

```

```{r}


# lapply(unique(rsa$roi),wbr.intactonly.corrplot,pstart =1,pend=25)
lapply(unique(rsa$roi),wbr.scrambledonly.corrplot,pstart =1,pend=5)
lapply(unique(rsa$roi),wbr.scrambledonly.corrplot,pstart =6,pend=10)
lapply(unique(rsa$roi),wbr.scrambledonly.corrplot,pstart =11,pend=15)
lapply(unique(rsa$roi),wbr.scrambledonly.corrplot,pstart =16,pend=20)
lapply(unique(rsa$roi),wbr.scrambledonly.corrplot,pstart =21,pend=25)

```


#### corr every time point

```{r}
pvalues = c()

wbr.intacteachp.corrplot = function(region,psta) {
rsa.diff.ps = rsa %>% filter(sub != "s023") 
# 

rsa.diff.ps = rsa.diff.ps %>% filter(position %in% pstart:pend) %>% group_by(sub,condition,roi) %>% filter(roi == "lh-hipp-body", condition == "intact") %>% summarise(simmean = mean(similarity))
# rsa.diff.ps = rsa.diff.ps %>%  spread(condition, simmean) 
# rsa.diff.ps = rsa.diff.ps %>% mutate(psdiffs = intact - scrambled)
rsa.diff.ps = data.frame(rsa.diff.ps)

rsa.diff.ps$intactrt = rt.intact$rtmean

# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s034")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s009")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s018")

fromcor = cor.test(rsa.diff.ps$intactrt,rsa.diff.ps$simmean)


c(pvalues,fromcor[3])
# c(rvalues,fromcor[4])
# if (fromcor[3] > .05){
# return()
# }
# 
# pval = sprintf('p = %.3f;',as.numeric(fromcor[3]))
# rval = sprintf('r = %.3f;',as.numeric(fromcor[4]))
# prange = sprintf('Reg %d to %d',pstart,pend)
# positive rt means faster on intact than scrambled 
# positive ps means higher ps for intact 

# corr.plot = ggplot(data = rsa.diff.ps,(aes(x = simmean, y= intactrt)))  + geom_point(size = 5) +   geom_smooth(method='lm')
# corr.plot = corr.plot + ggtitle(paste(region,pval,rval,prange))  + theme(legend.position="none") + labs(x = "Intact PS", y = "Intact PS (ms)")
# corr.plot = corr.plot + theme(text = element_text(size = 15, face = "bold"))
# corr.plot
# ggsave(sprintf('%s_intactonly_corrplot_pstart%dpend%d.pdf',region,pstart,pend), plot = last_plot(), dpi = 600 )
}

```


```{r}

lapply(1:32,wbr.intacteachp.corrplot)
```


# sliding time window ?????
```{r}

da_ps = c()

wbr.window.corrplot = function(midval,region,winval) {
rsa.diff.ps = rsa %>% filter(sub != "s023") 
# 

rsa.diff.ps = rsa.diff.ps %>% filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub,condition,roi_group) %>% filter(roi_group == region, condition != "random") %>% summarise(simmean = mean(similarity))
rsa.diff.ps = rsa.diff.ps %>%  spread(condition, simmean) 
rsa.diff.ps = rsa.diff.ps %>% mutate(psdiffs = intact - scrambled)
rsa.diff.ps = data.frame(rsa.diff.ps)

rsa.diff.ps$rtdiffs = rt.diffs$rtdiff

# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s034")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s009")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s018")

fromcor = cor.test(rsa.diff.ps$rtdiffs,rsa.diff.ps$psdiffs)

pval = fromcor$p.value
rval = fromcor$estimate
# pval = sprintf('%.3f',as.numeric(fromcor[3]))
# rval = sprintf('%.3f',as.numeric(fromcor[4]))

out = c(pval,rval)
return(out)

}

```


```{r}
# lapply(1:32,wbr.window.corrplot,winval = 5,region="lh-Prec")

# Calculate the number of cores
no_cores = detectCores() - 1
# Initiate cluster
cl = makeCluster(no_cores,type = "FORK")

corrdat = parLapply(cl,1:32,wbr.window.corrplot,winval = 0,region="LANG") # pm_sub late, temporal tp6, mpfc tp7, pfc othergroup tp7
corrdat = data.frame(matrix(unlist(corrdat), nrow=32, byrow=T))
corrdat$timepoint = 1:32
corrdat = plyr::rename(corrdat, c("X1"="pval","X2"="rval"))

stopCluster(cl)
```

```{r}
corr.plot = ggplot(data = corrdat,(aes(x =timepoint , y= rval,group =1)))  + geom_point(size = 3) +geom_line(size =2) + theme(text = element_text(size = 30, face = "bold"))  + ylab("Pearson's r") + 
geom_hline(aes(yintercept = 0)) + scale_y_continuous(limits = c(-.5,.5)) 
  # geom_segment(x = 2,y =-.05,xend= 2,yend = .05, color = "red",size=.75) +
  # geom_segment(x = 3,y =-.05,xend= 3,yend = .05, color = "red",size=.75) +
  # geom_segment(x = 4,y =-.05,xend= 4,yend = .05, color = "red",size=.75) +
  # geom_segment(x = 5,y =-.05,xend= 5,yend = .05, color = "red",size=.75) 
  # geom_segment(x = 13,y =-.05,xend= 13,yend = .05, color = "red",size=.75) +

corr.plot
# ggsave("march19_corr_figs/slidingcorrplot_rsa_pmmtl_ns.pdf", plot = corr.plot, dpi = 600,width = 8, height = 5,units = "in")
## 11-16 are sig
```

# merge the HIPP
# sliding time window ?????
```{r}

da_ps = c()

wbr.mergehipp.corrplot = function(midval,winval) {
rsa.diff.ps = rsa %>% filter(sub != "s023") 
# 

rsa.diff.ps = rsa.diff.ps %>% filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub,condition,roi) %>% filter(roi == "rh-hipp-body" | roi == "rh-hipp-tail" | roi == "rh-hipp-head" , condition != "random") %>% summarise(simmean = mean(similarity))
rsa.diff.ps = rsa.diff.ps %>%  spread(condition, simmean) 
rsa.diff.ps = rsa.diff.ps %>% mutate(psdiffs = intact - scrambled)
rsa.diff.ps = data.frame(rsa.diff.ps)

rsa.diff.ps$rtdiffs = rt.diffs$rtdiff

# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s034")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s009")
# rsa.diff.ps = rsa.diff.ps %>% filter(sub != "s018")

fromcor = cor.test(rsa.diff.ps$rtdiffs,rsa.diff.ps$psdiffs)

pval = sprintf('%.3f',as.numeric(fromcor[3]))
rval = sprintf('%.3f',as.numeric(fromcor[4]))

out = c(pval,rval)
return(out)


}

```


```{r}

corrdat = lapply(1:32,wbr.mergehipp.corrplot,winval = 2) # 
corrdat = data.frame(matrix(unlist(corrdat), nrow=32, byrow=T))
corrdat$timepoint = 1:32
corrdat = plyr::rename(corrdat, c("X1"="pval","X2"="rval"))
```

```{r}
corr.plot = ggplot(data = corrdat,(aes(x =timepoint , y= rval,group =1)))  + geom_point(size = 5)    
# corr.plot = corr.plot + ggtitle(paste(region,pval,rval,prange))  + theme(legend.position="none") + labs(x = "Pattern Similarity Difference", y = "Reaction Time Difference (ms)")
# corr.plot = corr.plot + theme(text = element_text(size = 15, face = "bold"))
corr.plot

```


























## Full within subject network*condition ANOVA with follow-up holm-corrected paired contrasts

```{r}

a1 = aov_ez("sub", "similarity", rsa.frontal, within = c("condition", "roi"))
a1
em1 = emmeans(a1, ~ condition|roi)
pairs(em1, adjust = NULL)
```


```{r}
rsa.select = rsa %>% filter(roi == "lh-MPFC" | roi == "rh-MPFC") %>%  group_by(condition,sub,roi) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
rsa.select = droplevels(rsa.select)
a1 = aov_ez("sub", "similarity", rsa.select, within = c("condition", "roi"))
a1
em1 = emmeans(a1, ~ condition|roi)
em1
pairs(em1, adjust = NULL)
```


## Make roi groups

```{r}
rsa.PM = rsa %>% filter(roi_group == "PM")
rsa.AT = rsa %>% filter(roi_group == "AT")
rsa.HIPP = rsa %>% filter(roi_group == "HIPP")
```

## Separate network plots

```{r fig.width = 12, fig.asp = .62}

pm.fig.dat = rsa.PMAT %>%  filter(roi_group == "PM") %>% group_by(sub,condition) %>% summarise(similarity = mean(similarity))
PM.check = ggplot(data = pm.fig.dat, aes(x = factor(condition), y = similarity))  + geom_boxplot(outlier.shape = NA) + scale_y_continuous(limits = c(-.05, .3))
PM.check = PM.check + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact","Same Position","Scrambled")) 
PM.check
# ggsave("pm.all.pdf", plot = last_plot(), dpi = 600 )

at.fig.dat = rsa.PMAT %>%  filter(roi_group == "AT") %>% group_by(sub,condition) %>% summarise(similarity = mean(similarity))
AT.check = ggplot(data = at.fig.dat, aes(x = factor(condition), y = similarity))  + geom_boxplot(outlier.shape = NA) + scale_y_continuous(limits = c(-.1, .3))
AT.check = AT.check + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact","Same Position","Scrambled"))
AT.check
# ggsave("at.all.pdf", plot = last_plot(), dpi = 600 )

#HIPP
# hipp.fig.dat = rsa.PMAT %>%  filter(roi_group == "HIPP") %>% group_by(sub,condition) %>% summarise(similarity = mean(similarity))
# hipp.check = ggplot(data = hipp.fig.dat, aes(x = factor(condition), y = similarity))  + geom_boxplot(outlier.shape = NA) + scale_y_continuous(limits = c(-.05, .17))
# hipp.check = hipp.check + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))
# hipp.check
# # ggsave("at.all.pdf", plot = last_plot(), dpi = 600 )

```

## Which PM ROIs drive effects
# Earlier observed that r_sameverb differeed from all other conditions in PM network 
# ROI*condition ANOVA indicated significant main effects of condition and roi, and a trending interaction
# Follow up contrasts indicate that r_sameverb is significantly different from at least one other condition in:
# lh-ANG,rh-ANG,lh-PCC,lh-Prec,rh-Prec
# Next will plot rh-Prec as representative region


```{r}
m1.PM = aov_ez("sub", "similarity", rsa.PM, within = c("condition", "roi"))
m1.PM
ls.PM = lsmeans(m1.PM,~condition|roi,contr = "pairwise", adjust = NULL)
# ls.PM
contrast(ls.PM, alpha=0.05, method="pairwise", adjust= "holm")
```

 
```{r}
pm.fig.dat = rsa %>%  filter(roi == "rh-Prec") %>% group_by(sub,condition) %>% summarise(similarity = mean(similarity))
PM.check = ggplot(data = pm.fig.dat, aes(x = factor(condition), y = similarity))  + geom_boxplot(outlier.shape = NA) + scale_y_continuous(limits = c(-.05, .3))
PM.check = PM.check + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact","Same Position","Scrambled")) 
PM.check
# ggsave("pm.all.pdf", plot = last_plot(), dpi = 600 )



# rsa.PM.example = rsa %>% filter(roi == "rh-Prec")
# PM.plot = ggplot(data = rsa.PM.example, aes(x = factor(condition), y = similarity)) + geom_boxplot(outlier.shape = NA) + theme(text = element_text(size = 25, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0))
# PM.plot = PM.plot + ylab("Similarity") + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))
# PM.plot
# ggsave("rh-prec.pdf", plot = last_plot(), dpi = 600 )
```

## Which AT ROIs drive effects
# Earlier we saw that intact and r_sameverb are different in AT (p = .03) and intact and scrambled are different (p = .04)
# Which ROIs drive that effect? Curiously this second ANOVA is trending for a main effect of condition...?
# Effect is driven by prc with, r-prc trending for difference between intact and r_samverb (p = .09) and intact and scrambled (p = .09)

```{r}
m1.AT = aov_ez("sub", "similarity", rsa.AT, within = c("condition", "roi"))
m1.AT
ls.AT = lsmeans(m1.AT,~condition|roi,contr = "pairwise", adjust = NULL)
# ls.AT
contrast(ls.AT, alpha=0.05, method="pairwise", adjust= "holm")
```



```{r}
at.fig.dat = rsa %>%  filter(roi == "rh-prc") %>% group_by(sub,condition) %>% summarise(similarity = mean(similarity))
at.check = ggplot(data = at.fig.dat, aes(x = factor(condition), y = similarity))  + geom_boxplot(outlier.shape = NA) + scale_y_continuous(limits = c(-.1, .3))
at.check = at.check + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled")) 
at.check
# ggsave("pm.all.pdf", plot = last_plot(), dpi = 600 )


# rsa.AT.example = rsa %>% filter(roi == "rh-prc")
# AT.plot = ggplot(data = rsa.AT.example, aes(x = factor(condition), y = similarity)) + geom_boxplot(outlier.shape = NA) + theme(text = element_text(size = 25, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0))
# AT.plot = AT.plot + ylab("Similarity") + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))
# AT.plot
```

## Which ROIs in HIPP are doing anything

```{r}
m1.HIPP = aov_ez("sub", "similarity", rsa.HIPP, within = c("condition","roi"))
m1.HIPP
ls.HIPP = lsmeans(m1.HIPP,~condition|roi,contr = "pairwise", adjust = NULL)
# ls.HIPP
contrast(ls.HIPP, alpha=0.05, method="pairwise", adjust= "holm")
```

## plot left hipp body

```{r}
rsa.HIPP.example = rsa %>% filter(roi_group == "HIPP") %>% group_by(sub,condition,roi) %>% summarise(similarity = mean(similarity))
HIPP.plot = ggplot(data = rsa.HIPP.example, aes(x = factor(condition), y = similarity)) + geom_boxplot(outlier.shape = NA) + theme(text = element_text(size = 25, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0))
HIPP.plot = HIPP.plot + ylab("Similarity") + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))
HIPP.plot
```

```{r}
rsa.VMPFC = rsa %>% filter(roi == "rh-VMPFC") %>% group_by(sub,condition) %>% summarise(similarity = mean(similarity))
VMPFC.plot = ggplot(data = rsa.VMPFC, aes(x = factor(condition), y = similarity)) + geom_boxplot(outlier.shape = NA) + theme(text = element_text(size = 25, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0))
VMPFC.plot = VMPFC.plot + ylab("Similarity") + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))
VMPFC.plot
```



## VMPFC, nada yet

```{r}
rsa.VMPFC = rsa %>% filter(roi == "lh-VMPFC")
m1.VMPFC = aov_ez("sub", "similarity", rsa.VMPFC, within = c("condition"))
m1.VMPFC
ls.VMPFC = lsmeans(m1.VMPFC,~condition,contr = "pairwise", adjust = NULL)
ls.VMPFC
contrast(ls.VMPFC, alpha=0.05, method="pairwise", adjust= "holm")
```

```{r fig.width = 12, fig.asp = .62}

pm.fig.dat = rsa.PMAT %>%  filter(roi_group == "PM") %>% group_by(sub,roi,condition) %>% summarise(similarity = mean(similarity))
PM.check = ggplot(data = pm.fig.dat, aes(x = factor(condition), y = similarity))  + geom_boxplot(outlier.shape = NA) + scale_y_continuous(limits = c(-.05, .3)) +  facet_wrap( ~roi, ncol=5)
PM.check = PM.check + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled")) 
PM.check
```

```{r fig.width = 12, fig.asp = .62}

pm.fig.dat = rsa %>%  filter(roi_group == "HIPP") %>% group_by(sub,roi,condition) %>% summarise(similarity = mean(similarity))
PM.check = ggplot(data = pm.fig.dat, aes(x = factor(condition), y = similarity))  + geom_boxplot(outlier.shape = NA) + scale_y_continuous(limits = c(-.05, .2)) +  facet_wrap( ~roi, ncol=3)
PM.check = PM.check + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled")) 
PM.check
```



```{r fig.width = 12, fig.asp = .62}

multi.fig.dat = rsa %>% group_by(sub,roi,condition) %>% summarise(similarity = mean(similarity))

for (ipage in 1:12) {
  ggplot(data = multi.fig.dat, aes(x = factor(condition), y = similarity)) + scale_y_continuous(limits = c(-.05, .3)) + geom_boxplot() + facet_wrap_paginate(~roi, nrow=2, ncol=2, page=ipage) + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled"))
  fname = sprintf("reg_correct_5ptile_10_27_18_%d.pdf", ipage) 
  ggsave(fname)
}
```

```{r}
rsa.IFG = rsa %>% filter(roi_group == "IFG")
m1.IFG = aov_ez("sub", "similarity", rsa.IFG, within = c("condition", "roi"))
m1.IFG
ls.IFG = lsmeans(m1.IFG,~condition|roi,contr = "pairwise", adjust = NULL)
# ls.IFG
contrast(ls.IFG, alpha=0.05, method="pairwise", adjust= "holm")
```

```{r fig.width = 12, fig.asp = .62}

pm.fig.dat = rsa.IFG %>% group_by(sub,roi,condition) %>% summarise(similarity = mean(similarity))
PM.check = ggplot(data = pm.fig.dat, aes(x = factor(condition), y = similarity))  + geom_boxplot() + scale_y_continuous(limits = c(-.05, .3)) +  facet_wrap( ~roi, ncol=5)
PM.check = PM.check + ylab("Similarity") + theme(text = element_text(size = 30, face = "bold"),axis.title.x=element_blank(),axis.text.x=element_text(angle = -45,hjust = 0)) + scale_x_discrete(labels = c("Intact", "Same Verb","Same Position","Scrambled")) 
PM.check
```

```{r}
# is anything sig dif with intact besides same position??
# rsa$sub = factor(rsa$sub)
# rsa.all = rsa %>% filter(rsa$position == 1)  
# rsa.all = rsa.all %>% filter(rsa$sub != "s041")
# rsa.all = rsa.all %>%   group_by(sub,roi,condition) %>% summarise(similarity =mean(similarity))
# rsa.all = rsa %>% filter(rsa$roi != "lh-occ-pole")
m1.all = aov_ez("sub", "similarity", rsa, within = c("condition", "roi"))
m1.all
ls.all = lsmeans(m1.all,~condition|roi,contr = "pairwise", adjust = NULL)
# ls.IFG
contrast(ls.all, alpha=0.05, method="pairwise", adjust= "holm")
```

```{r}
rsa.mpfc = rsa %>% filter(rsa$roi == "lh-MPFC" )
rsa.mpfc = rsa.mpfc %>% group_by(sub,roi,condition) %>% summarise(similarity = mean(similarity))
m1.all = aov_ez("sub", "similarity", rsa.mpfc, within = c("condition"))
m1.all
ls.all = lsmeans(m1.all,~condition,contr = "pairwise", adjust = NULL)
ls.all
contrast(ls.all, alpha=0.05, method="pairwise", adjust= "holm")
```

```{r}
rsa.mpfc = rsa %>% filter(rsa$roi == "rh-inf-triang" )
rsa.mpfc = rsa.mpfc %>% group_by(sub,roi,condition) %>% summarise(similarity = mean(similarity))
m1.all = aov_ez("sub", "similarity", rsa.mpfc, within = c("condition"))
m1.all
ls.all = lsmeans(m1.all,~condition,contr = "pairwise", adjust = NULL)
ls.all
contrast(ls.all, alpha=0.05, method="pairwise", adjust= "holm")
```


#################
# sliding window effect size

```{r}
library(effsize)
wbr.sliding.effectsize = function(midval,region,winval,con1,con2) {
  temp.df = rsa %>% filter(roi == region) %>% filter(condition == con1) %>%   filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat1 = temp.df$similarity

temp.df = rsa %>% filter(roi == region) %>% filter(condition == con2) %>%   filter(position %in% (midval-winval):(midval+winval)) %>% group_by(sub) %>% summarise(similarity = mean(similarity)) %>%  ungroup()
temp.df = droplevels(temp.df)
dat2 = temp.df$similarity

if (length(dat1) == length(dat2)){
  print(region)
  result = cohen.d(dat1, dat2, paired = TRUE)
  size = result$estimate
  
# pval = sprintf('%.3f',as.numeric(fromcor[3]))
# rval = sprintf('%.3f',as.numeric(fromcor[4]))

  out = size
  return(out)
  
} else {
  fprint('problem with %s !!!',region )
}
}
```

```{r}
tstatdat = lapply(1:32,wbr.sliding.effectsize,winval=2,region="L_POS1_ROI",con1="intact",con2="scrambled")
tstatdat = data.frame(matrix(unlist(tstatdat), nrow=32, byrow=T))
tstatdat$timepoint = 1:32
colnames(tstatdat) =  c("tval", "timepoint")

#plot that shit
tstat.plot = ggplot(data = tstatdat,(aes(x =timepoint , y= tval,group =1)))  + geom_point(size = 3) +geom_line(size =2) + theme(text = element_text(size = 30, face = "bold"))  + ylab("cohen's d")  +
geom_hline(aes(yintercept = 0)) + scale_y_continuous(limits= c(-1 , 1))
# +
  # geom_segment(x = 18,y =-.25,xend= 18,yend = .25, color = "red",size=.75) 
#   geom_segment(x = 29,y =-.25,xend= 29,yend = .25, color = "red",size=.75) +
#   geom_segment(x = 28,y =-.25,xend= 28,yend = .25, color = "red",size=.75) +
#   geom_segment(x = 30,y =-.25,xend= 30,yend = .25, color = "red",size=.75) +
#   geom_segment(x = 31,y =-.25,xend= 31,yend = .25, color = "red",size=.75) 


tstat.plot
# ggsave("sfn18_figs/sliding.tstat_lh-MTG.pdf", plot = tstat.plot, dpi = 600,width = 8, height = 5,units = "in")

# lh-Prec sig ttest at p1-p6
```











